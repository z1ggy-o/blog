<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LevelDB 源码分析笔记 | Ziggy&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/blog/img/favicon.ico">
    <meta name="description" content="Personal blogs and wikis">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/blog/assets/css/0.styles.802db94a.css" as="style"><link rel="preload" href="/blog/assets/js/app.e93f84ee.js" as="script"><link rel="preload" href="/blog/assets/js/2.5f4b96d7.js" as="script"><link rel="preload" href="/blog/assets/js/49.558f223c.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.186ef0aa.js"><link rel="prefetch" href="/blog/assets/js/11.a86b52a7.js"><link rel="prefetch" href="/blog/assets/js/12.a1136d27.js"><link rel="prefetch" href="/blog/assets/js/13.ff2c4670.js"><link rel="prefetch" href="/blog/assets/js/14.457f2c8c.js"><link rel="prefetch" href="/blog/assets/js/15.6208c784.js"><link rel="prefetch" href="/blog/assets/js/16.64dd4f4a.js"><link rel="prefetch" href="/blog/assets/js/17.55f7112c.js"><link rel="prefetch" href="/blog/assets/js/18.13638b8d.js"><link rel="prefetch" href="/blog/assets/js/19.4cdde176.js"><link rel="prefetch" href="/blog/assets/js/20.826d32cf.js"><link rel="prefetch" href="/blog/assets/js/21.4e6f0671.js"><link rel="prefetch" href="/blog/assets/js/22.31699819.js"><link rel="prefetch" href="/blog/assets/js/23.9a9fd78b.js"><link rel="prefetch" href="/blog/assets/js/24.7986b4d7.js"><link rel="prefetch" href="/blog/assets/js/25.d71b9122.js"><link rel="prefetch" href="/blog/assets/js/26.329cf0b3.js"><link rel="prefetch" href="/blog/assets/js/27.adb54146.js"><link rel="prefetch" href="/blog/assets/js/28.8f3e00d0.js"><link rel="prefetch" href="/blog/assets/js/29.f90ab39f.js"><link rel="prefetch" href="/blog/assets/js/3.c53c04e3.js"><link rel="prefetch" href="/blog/assets/js/30.cbeee5c0.js"><link rel="prefetch" href="/blog/assets/js/31.4c6252e6.js"><link rel="prefetch" href="/blog/assets/js/32.76d84000.js"><link rel="prefetch" href="/blog/assets/js/33.926a1eaa.js"><link rel="prefetch" href="/blog/assets/js/34.e61db008.js"><link rel="prefetch" href="/blog/assets/js/35.1f9c32a2.js"><link rel="prefetch" href="/blog/assets/js/36.44c19630.js"><link rel="prefetch" href="/blog/assets/js/37.3f89591a.js"><link rel="prefetch" href="/blog/assets/js/38.89d2fed2.js"><link rel="prefetch" href="/blog/assets/js/39.aa7a6d7b.js"><link rel="prefetch" href="/blog/assets/js/4.27b51db5.js"><link rel="prefetch" href="/blog/assets/js/40.167faf08.js"><link rel="prefetch" href="/blog/assets/js/41.aa0aa0fd.js"><link rel="prefetch" href="/blog/assets/js/42.9b534057.js"><link rel="prefetch" href="/blog/assets/js/43.1d8d0c92.js"><link rel="prefetch" href="/blog/assets/js/44.02be069d.js"><link rel="prefetch" href="/blog/assets/js/45.bdbf7611.js"><link rel="prefetch" href="/blog/assets/js/46.e695b7f9.js"><link rel="prefetch" href="/blog/assets/js/47.ab9934c1.js"><link rel="prefetch" href="/blog/assets/js/48.bbb27d8e.js"><link rel="prefetch" href="/blog/assets/js/5.9b6dc29e.js"><link rel="prefetch" href="/blog/assets/js/50.c6dce237.js"><link rel="prefetch" href="/blog/assets/js/51.80faa8c8.js"><link rel="prefetch" href="/blog/assets/js/52.b74f159e.js"><link rel="prefetch" href="/blog/assets/js/53.750a01b7.js"><link rel="prefetch" href="/blog/assets/js/54.c69b6309.js"><link rel="prefetch" href="/blog/assets/js/55.ee0a152f.js"><link rel="prefetch" href="/blog/assets/js/56.3917d1d7.js"><link rel="prefetch" href="/blog/assets/js/57.c0cf0a53.js"><link rel="prefetch" href="/blog/assets/js/58.1c316d1a.js"><link rel="prefetch" href="/blog/assets/js/59.7c26bb76.js"><link rel="prefetch" href="/blog/assets/js/6.ac011902.js"><link rel="prefetch" href="/blog/assets/js/60.082a63b3.js"><link rel="prefetch" href="/blog/assets/js/61.c54fff04.js"><link rel="prefetch" href="/blog/assets/js/62.635a0c4f.js"><link rel="prefetch" href="/blog/assets/js/63.a5e9dfc4.js"><link rel="prefetch" href="/blog/assets/js/64.dd4097c5.js"><link rel="prefetch" href="/blog/assets/js/65.7db1f157.js"><link rel="prefetch" href="/blog/assets/js/7.c3622e2f.js"><link rel="prefetch" href="/blog/assets/js/8.86e22913.js"><link rel="prefetch" href="/blog/assets/js/9.7d24983f.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.802db94a.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Ziggy's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="系列文章" class="dropdown-title"><!----> <span class="title" style="display:;">系列文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/089ecd/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><!----> <span class="title" style="display:;">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/booknotes/" class="nav-link">读书笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/papernotes/" class="nav-link">论文笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Logs" class="dropdown-title"><a href="/blog/logs/" class="link-title">Logs</a> <span class="title" style="display:none;">Logs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/logs/weekly/" class="nav-link">周记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/blog/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="系列文章" class="dropdown-title"><!----> <span class="title" style="display:;">系列文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/089ecd/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><!----> <span class="title" style="display:;">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/booknotes/" class="nav-link">读书笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/papernotes/" class="nav-link">论文笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Logs" class="dropdown-title"><a href="/blog/logs/" class="link-title">Logs</a> <span class="title" style="display:none;">Logs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/logs/weekly/" class="nav-link">周记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/blog/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>LevelDB 源码分析笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/pages/2f7119/#leveldb-一个-lsm-tree-的开源实现" class="sidebar-link">LevelDB，一个 LSM-Tree 的开源实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/pages/2f7119/#写入-memtable-和-sstable" class="sidebar-link">写入：Memtable 和 SSTable</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/pages/2f7119/#读取-sstable-结构和-mvcc" class="sidebar-link">读取：SSTable 结构和 MVCC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/2f7119/#sstable-结构" class="sidebar-link">SSTable 结构</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/2f7119/#mvcc" class="sidebar-link">MVCC</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/2f7119/#cache" class="sidebar-link">Cache</a></li></ul></li><li><a href="/blog/pages/2f7119/#清理-compaction" class="sidebar-link">清理，Compaction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/pages/2f7119/#结语" class="sidebar-link">结语</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><!----> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/z1ggy-o" target="_blank" title="作者" class="beLink" data-v-06225672>gyzhu</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-08-22</a></div> <div title="分类" class="date iconfont icon-wenjian" data-v-06225672><a href="/blog/categories/?category=articles" data-v-06225672>articles </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">LevelDB 源码分析笔记<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p>最近一周花了些时间阅读了 LevelDB 的代码，了解一下 LSM-Tree 的具体实现。在阅读的过程中简略的记录了一些笔记，放在了我的 <a href="https://github.com/z1ggy-o/LevelDB-Notes/tree/main/Notes" target="_blank" rel="noopener noreferrer">Github repo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 里。笔记是用蹩脚英语写的，也没有做任何的插图，建议配合<a href="https://leveldb-handbook.readthedocs.io/zh/latest/basic.html" target="_blank" rel="noopener noreferrer">此分析文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一起食用。</p> <p>LSM-Tree 虽然很早被提出，但是在 LevelDB 这个开源实现被公开之后才引发了比较广泛的研究。毕竟，<s>拿来的是最舒服的</s>，虽然概念简单，但是细节很多。有些时候代码比语言更清晰，所以，我的笔记里主要还是将概念和具体的代码做了关联，细节还是要到代码里去扣。</p> <p>在这里，主要想要用简单的语言介绍一下 LevelDB 的主要框架。方便想要花五分钟大致了解一下 LevelDB 的朋友。</p> <h2 id="leveldb-一个-lsm-tree-的开源实现"><a href="#leveldb-一个-lsm-tree-的开源实现" class="header-anchor">#</a> LevelDB，一个 LSM-Tree 的开源实现</h2> <p><a href="https://en.wikipedia.org/wiki/Log-structured_merge-tree" target="_blank" rel="noopener noreferrer">LSM-Tree<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的特点在于其对存储内容的排序和 append-only 的写入模式。此工作模式主要有两个优点：</p> <ul><li>极佳的写入性能。不需要做 read-modify-write。</li> <li>便利的并行控制。写入的内容不会再被修改，可以放心的做并行读取。</li></ul> <p>但是物理世界里，一切都是有利弊的。LSM-Tree 的读取性能并不优秀。因为有过期数据的存在，读取过程中可能会需要读取多个文件，会有 read-amplification 的问题。过期数据也会浪费存储空间。</p> <p>插一句，对 write-amplification (WA) 问题，LSM-Tree 和 B-Tree 两者都有，但是具体的情景是不一样的。LSM-Tree 的 WA 来源于 compaction 过程，需要将已有的数据重新写入。而 B-Tree 的 WA 来源于其固定 page 大小的写入单位。就算一个 page 内只有一个 byte 被修改了，整个 page 也需要写回。</p> <p>接下来主要针对 LevelDB 的写入和读取两个部分的设计部件作一下简介。</p> <h2 id="写入-memtable-和-sstable"><a href="#写入-memtable-和-sstable" class="header-anchor">#</a> 写入：Memtable 和 SSTable</h2> <p>LevelDB 只允许写入请求（即插入，更新，删除）发生在内存内的 memtable 中。Memtable 是实现于 skiplist 数据结构，在提供良好插入性能的情况下也保持 item 有序。</p> <p>当一个 memtable 达到预定的大小之后，memtable 会被写入到磁盘中，成为一个 SSTable 文件。因为在 memtable 写出的时候就不能再接收写请求了，LevelDB 使用了 double-buffer 的策略，另起一个 memtable 接收写请求。</p> <p>为了避免故障带来的数据损失，LevelDB 也使用了 WAL 的方式来记录请求内容。不过因为 LevelDB 只是一个简单的 KV 引擎，log 几乎就是请求内容的复制记录。而且，在 memtable 被持久化之后，对应的 log 文件就可以抛弃了。</p> <p>总的来说，log-structuring 本身已经为写入带来了极大的便利，所以这个部分的特别设计并不多。</p> <h2 id="读取-sstable-结构和-mvcc"><a href="#读取-sstable-结构和-mvcc" class="header-anchor">#</a> 读取：SSTable 结构和 MVCC</h2> <p>因为 LSM-Tree 的读取性能并不好，LevelDB 为了提升读取性能还是花了一番力气的。</p> <h3 id="sstable-结构"><a href="#sstable-结构" class="header-anchor">#</a> SSTable 结构</h3> <p>Memtable 只是一个 skiplist，其中一个 node 代表一个写入请求指令的内容。如何将这些内容进行安排，决定了读取过程的效率。LevelDB 主要做了一下几个设计：</p> <ul><li>SSTable 文件按新旧序号排列。更新的文件中自然存放着更新的数据。</li> <li>SSTable 文件的底部设计了一个 footer 部分，可以帮助快速识别目标 key 所在的位置，减少读取量。</li> <li>SSTable 内部嵌入 bloom filter，进一步减少不必要的读取。</li></ul> <p>更加具体的内容请参照笔记和源码。</p> <h3 id="mvcc"><a href="#mvcc" class="header-anchor">#</a> MVCC</h3> <p>LevelDB 是支持针对数据进行 snapshot 读取的。它的实现方式倒也简单直接。在 DB 的每一条记录中，都包含一个单调递增的 sequence number。当要进行 snapshot 读取的时候，LevelDB 会告诉读请求当时的最新 sequence number。如此一来通过比较，就可以避免读到更新的数值了。这个设计的好处在于，读不会阻塞写。</p> <p>LevelDB 抽象了一个 <code>Version</code> 对象，记录了一个版本的文件。每当有 sstable 生成或删除的时候，就形成一个新的版本。如果有请求在使用某个版本的文件，那么即使这个文件已经过期，也会等到所有的使用都完毕之后才会被清理。</p> <h3 id="cache"><a href="#cache" class="header-anchor">#</a> Cache</h3> <p>除此之外，LevelDB 也实现了一个比较标准的 LRUCache。该 cache 主要缓存打开的文件句柄，以及读取的数据块。</p> <p>用户也可以选择不使用这个 cache。比如，如果做大范围的 range read 的话，用 cache 的意义不大。</p> <h2 id="清理-compaction"><a href="#清理-compaction" class="header-anchor">#</a> 清理，Compaction</h2> <p>因为 append-only 的写入方式会让 DB 中存有过期的数据，我们需要定期的对数据进行清理，释放不需要的存储空间。</p> <p>LevelDB 使用 leveling compaction 的方式来做这个清理。具体来说，sstable 文件被按层级安排在了一起，低层的数据存放量少，数据更新；高层的数据存放量更大，但是数据旧。</p> <p>compaction 是在两个相邻层级中的文件中进行的。先是在上层中找到一个对象文件，然后根据其 key 的范围，在下一层中找到有 key 重叠的文件。最后，因为所有的记录都是排好序的，利用 k-way merge 的方式就可以将过期的数据筛除。有效的数据被写入到新的 sstable 文件中，放入到下层里。这个过程可能在各个层级递归进行。</p> <p>寻找 compaction 对象文件的过程略微复杂，有兴趣可以参照笔记和源码学习。</p> <p>因为 compaction 是一个比较昂贵的操作，LevelDB 定义了三个条件来决定是否需要做 compaction：</p> <ul><li>Level 0 （最低层）的文件数量超过了限制；</li> <li>其他层的数据量超过了限制；</li> <li>一个文件的无效读取次数超过了限制。</li></ul> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>LevelDB 的代码量并不算很大，但是确实设计的很好。早就听说这是一个学习 C++ 的好材料，如今一读，确实如此。特别是对于我这种常年打 C 补丁的选手，LevelDB 实打实的给上了一节 OOP 的实践课。也推荐给所有想了解 LSM-Tree，学习 C++ OOP 范式的同学阅读。</p></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/blog/tags/?tag=DBMS" title="标签">#DBMS</a><a href="/blog/tags/?tag=LSM-Tree" title="标签">#LSM-Tree</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/09/17, 14:09:04</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/blog/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/pages/c93ce8/"><div>
            2024-01-W2
            <!----></div></a> <span class="date">01-12</span></dt></dl><dl><dd>02</dd> <dt><a href="/blog/pages/237d08/"><div>
            FAST'20 - BCW: Buffer-Controlled Writes to HDDs for SSD-HDD Hybrid Storage Server
            <!----></div></a> <span class="date">09-17</span></dt></dl><dl><dd>03</dd> <dt><a href="/blog/pages/a95802/"><div>
            OSDI'22 - BlockFlex: Enabling Storage Harvesting with Software-Defined Flash in Modern Cloud Platforms
            <!----></div></a> <span class="date">08-07</span></dt></dl> <dl><dd></dd> <dt><a href="/blog/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/z1ggy-o" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2024
    <span>Ziggy| <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.e93f84ee.js" defer></script><script src="/blog/assets/js/2.5f4b96d7.js" defer></script><script src="/blog/assets/js/49.558f223c.js" defer></script>
  </body>
</html>
